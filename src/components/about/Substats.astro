---
import { socialLinks, type iconsType } from 'astro-pure/types'
import { Icon } from 'astro-pure/user'

interface SubstatsItem {
  platform: string
  icon: (typeof socialLinks)[number]
  color?: string
  link?: string
  text: string
  api?: string
  count?: number
}

type Props = {
  stats: SubstatsItem[]
}

const { stats } = Astro.props as Props

async function fetchCount(item: SubstatsItem) {
  if (!item.api) return
  
  // GitHub API 直接获取
  if (item.api.startsWith('github/')) {
    const username = item.api.replace('github/', '')
    try {
      const response = await fetch(`https://api.github.com/users/${username}`)
      if (!response.ok) {
        throw new Error(`GitHub API ${response.status}: ${response.statusText}`)
      }
      const data = await response.json()
      item.count = data.followers
      return
    } catch (error) {
      console.error(`GitHub API error for ${username}:`, error)
      // 继续尝试 Substats API
    }
  }
  
  // 备用：Substats API
  try {
    const controller = new AbortController()
    const timeoutId = setTimeout(() => controller.abort(), 5000)
    
    const response = await fetch(`https://api.swo.moe/stats/${item.api}`, {
      signal: controller.signal
    })
    
    clearTimeout(timeoutId)
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`)
    }
    
    const data = await response.json()
    console.log(`Substats API response for ${item.api}:`, data)
    
    if (data.failed) {
      throw new Error(data.message || 'API returned failed status')
    } else if (typeof data.count === 'number') {
      item.count = data.count
    } else {
      throw new Error(`Invalid count value: ${data.count}`)
    }
  } catch (error) {
    console.error(`Error fetching stats for ${item.api}: ${error}`)
    item.count = -1 // 用 -1 表示获取失败
  }
}

await Promise.all(stats.map(fetchCount))
---

<div class='grid grid-cols-1 gap-3 rounded-xl border p-2 sm:grid-cols-2 sm:p-3'>
  {
    stats.map(({ link, platform, icon, color, count, text }) => (
      <a
        class='group text-muted-foreground no-underline'
        href={link}
        target='_blank'
        rel='noopener noreferrer'
      >
        <div class='flex items-center gap-3 rounded-lg border border-transparent px-3 py-2 transition-all hover:border-border hover:bg-muted'>
          {icon && <Icon name={icon as iconsType} color={color} />}
          <div class='flex-1 text-foreground transition-colors group-hover:text-primary'>
            {platform}
          </div>
          {count !== undefined ? (
            count === -1 ? (
              <span class='text-sm text-red-500'>Failed to load</span>
            ) : (
              <div class='flex items-center gap-1.5'>
                <samp>{count}</samp>
                <span class='text-sm font-normal'>{text}</span>
              </div>
            )
          ) : (
            <span class='text-sm text-yellow-500'>Loading...</span>
          )}
        </div>
      </a>
    ))
  }
</div>
<div class='mt-2 text-right text-sm'>
  Display real-time; powered by <a
    class='text-muted-foreground'
    href='http://github.com/spencerwooo/substats'
    target='_blank'
    rel='noopener noreferrer'>Substats</a
  >
</div>
